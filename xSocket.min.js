var xSocket=function t(){t.Client.apply(this,arguments)};xSocket.window=window||!1,xSocket.WebSocket=WebSocket||!1,xSocket.process=!1,(window.xSocket=xSocket).helpers=new function(){this.getWindow=function(){return xSocket.window},this.getProcess=function(){return xSocket.process},this.getRandInt=function(t,e){return Math.floor(t+Math.random()*(e+1-t))},this.EventEmitter=function(){var c=this,u={},o=0,i=10,a="_once";this.on=function(t,e,n){if("string"!=typeof t||"function"!=typeof e)return c;++o;n=String(String(o)+(!0===n?a:""));return"object"!=typeof u[t]&&(u[t]={}),u[t][n]=e,0<i&&c.listenerCount(t)>i&&console.warn("EventEmitter ",t,", exceeded maxListeners : ",i+"/"+c.listenerCount(t),". Use EE.setMaxListeners(n)!"),c},this.once=function(t,e){return c.on(t,e,!0)},this.getListerensName=function(){return Object.keys(u)},this.clearAllListerens=function(){var t,e=c.getListerensName();for(t in e)c.offAll(e[t]);return u},this.listenerCount=function(t){return"string"!=typeof t||"object"!=typeof u[t]?0:Object.keys(u[t]).length},this.setMaxListeners=function(t){return"number"==typeof t&&(i=parseInt(t),!0)},this.off=function(t,e){if("string"!=typeof t||"function"!=typeof e||"object"!=typeof u[t])return c;for(var n in u[t])u[t][n]===e&&delete u[t][n];return 0===Object.keys(u[t]).length&&delete u[t],c},this.offAll=function(t){if("object"!=typeof u[t])return c;for(var e in u[t])delete u[t][e];return delete u[t],c},this.emit=function(t,e,n,o,i,r){if("string"!=typeof t||"object"!=typeof u[t])return c;for(var s in u[t])"function"==typeof u[t][s]&&(u[t][s].call(this,e,n,o,i,r),0<=s.indexOf(a)&&c.off(t,u[t][s]));return c}},this.getUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t,e){return("x"==t?e=16*Math.random()|0:3&e|8).toString(16)})},this.checkUID=function(t){return!!new RegExp("^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$").test(String(t))}},xSocket.Data=function(t,e){e="object"==typeof e?e:{},xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var n,o,i=this;this.__ID="string"==typeof e.ID?e.ID:"",this.__type="string"==typeof e.type?e.type:"",this.__data="object"==typeof e.data?e.data:{},this.__ttl="number"==typeof e.ttl&&e.ttl%1==0&&0<=e.ttl?e.ttl:3e3,this.__resData={},this.__error=!1,this.__status=xSocket.Data.STATUS_NEW,this.__destroy=!1,this.getID=function(){return String(this.__ID)},this.getType=function(){return String(this.__type)},this.getTTL=function(){return this.__ttl},this.getData=function(){return this.__data||{}},this.getResData=function(){return this.__resData},this.getStatus=function(){return parseInt(this.__status)},this.getDestroy=function(){return this.__destroy||!1},this.response=function(t){return new Promise(function(){throw new Error("This SocketData is output, use response event")})},this.getError=function(){return this.__error||this.getDestroy()||!1},this.isNew=function(){return this.__status===xSocket.Data.STATUS_NEW},this.isSend=function(){return this.__status===xSocket.Data.STATUS_SEND},this.isResponse=function(){return this.__status===xSocket.Data.STATUS_RESPONSE},this.send=function(){return new Promise(function(e,n){if(i.getDestroy())return n(new Promise(i.getDestroy));t&&i.emit("send"),i.on("response",function(t){e(t)}),i.on("destroy",function(t){n(new Error(t))})})},this.setStatus=function(t){return-1!==[xSocket.Data.STATUS_SEND,xSocket.Data.STATUS_RESPONSE].indexOf(t)&&this.getStatus()!==xSocket.Data.STATUS_RESPONSE&&this.getStatus()!==t&&(this.__status=t,this.emit("setStatus",t),!0)},this.setError=function(t){return"string"==typeof t&&(this.__error=String(t),!0)},this.setResData=function(t){return"object"==typeof t&&(this.__resData=t,!0)},this.destroy=function(t){if(this.getDestroy())return!1;this.__destroy=String("string"==typeof t&&t.length?t:"destroy"),this.getStatus()!==xSocket.Data.STATUS_RESPONSE&&i.setStatus(xSocket.Data.STATUS_RESPONSE),this.emit("destroy",this.__destroy),this.clearAllListerens()},n=setTimeout(function(){i.destroy("ttl")},i.getTTL()),o=setTimeout(function(t){t.destroy("responseTimeout")},1e4<i.getTTL()?i.getTTL():1e4,i),i.once("destroy",function(){try{clearTimeout(o)}catch(t){}try{clearTimeout(n)}catch(t){}}),i.on("setStatus",function(t){t===xSocket.Data.STATUS_RESPONSE&&(i.emit("response",i.getResData(),i.getError()),i.destroy("response"))})},xSocket.Data.STATUS_NEW=0,xSocket.Data.STATUS_SEND=1,xSocket.Data.STATUS_RESPONSE=2,xSocket.xSocketObject=function(e,t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var s=this,n=void 0,o="",i="",r=void 0,c=!0,u={},a={};this.getID=function(){return o||""},this.getSign=function(){return i||""},this.getReq=function(){return t||{}},this.getQuery=function(){return"object"==typeof a?a:{}},this.getQueryVal=function(t,e){return this.getQuery()[t]||e},this.getReqHeaders=function(){return this.getReq().headers||{}},this.getOrigin=function(){return this.getReqHeaders().origin||"unknown"},this.getIP=function(){return String((this.getReq().connection||{}).remoteAddress||"unknown")},this.getSocketDataList=function(){return u},this.getSocketData=function(t){return this.getSocketDataList()[t]||!1},this.isConnection=function(){return"object"==typeof n&&n.isConnection()},this.getConnection=function(){return!!this.isConnection()&&n},this.getDestroy=function(){return r||!1},this.isDestroy=function(){return!!this.getDestroy()},this.getWsReady=function(){return new Promise(function(t,e){if(s.getConnection())return t(s.getConnection());function n(){e(new Error("destroy"))}s.on("connect",function(){s.getConnection()?t(s.getConnection()):e(new Error("Failed connection #10fg42w")),s.off("destroy",n)}),s.once("destroy",n)})},this.send=function(o,i,r){var t=new Promise(function(t,e){var n=new xSocket.Data(!0,{ID:xSocket.helpers.getUID(),type:o,data:i,ttl:r});n.getTTL()&&(u[n.getID()]=n).on("destroy",function(){delete u[n.getID()]}),t(n),s.getWsReady().then(function(t){return t.sendObject(["SD|create",{ID:n.getID(),type:n.getType(),ttl:n.getTTL(),data:n.getData()}])?void n.setStatus(n.getTTL()?xSocket.Data.STATUS_SEND:xSocket.Data.STATUS_RESPONSE):n.destroy("Failed send #54te8ta65")}).catch(function(t){n.destroy(t.message||"Failed send #2e4uxDql")})});return t.catch(function(){}),t},this.sendReadyResponse=function(t,e,n){return new Promise(function(o,i){s.send(t,e,n).then(function(n){return n.isResponse()?n.getError()?i(new Error(n.getError())):o(n):void n.on("response",function(t,e){return e?i(new Error(e)):void o(n)})}).catch(function(t){i(t)})})},this.sendReady=function(){return this.sendReadyResponse.apply(this,arguments)},this.destroy=function(t){return!r&&(r=String(t||"destroy"),this.disconnect(r),this.emit("destroy",this,r),this.clearAllListerens(),!0)},this.disconnect=function(t){var e=this.getConnection();return!(!e||!this.isConnection())&&e.closeConnection(t)},this.update=function(t){return"object"==typeof t&&"function"==typeof t.isConnection&&"object"==typeof t.query&&(!(!t.isConnection()||r)&&(o===t.query.xSOId&&i===t.query.xSOSign||(o=t.query.xSOId,i=t.query.xSOSign,(a=Object(t.query||{})).xSOId&&delete a.xSOId,a.xSOSign&&delete a.xSOSign,e||s.emit("update",s)),(n=t).SocketObject=t,s.emit("ws|connect",t),!0))},s.on("update",function(){var t,e=s.getSocketDataList();for(t in e)try{e[t].destroy("SocketObject|destroy")}catch(t){}}),s.on("ws|disconnect",function(t){s.emit("disconnect",s,String(t||"")),"end"===t&&s.destroy("end")}),s.on("ws|connect",function(){s.emit("connect",s),c?c=!1:s.emit("reconnect",s)}),s.on("ws|message",function(t,e){var i;"string"==typeof t&&t.length&&"object"==typeof e&&"string"==typeof e.ID&&xSocket.helpers.checkUID(e.ID)&&e.ID.length&&"object"==typeof e.data&&("SD|create"===t?("string"==typeof e.type&&e.type.length||!s.getSocketData(e.ID))&&((i=new xSocket.Data(!1,e)).response=function(n,o){var t=new Promise(function(t,e){if(i.getDestroy()||i.isResponse()||!i.getTTL())return!1;i.setResData(n),i.setError(o),i.on("destroy",function(t){e(new Error(t||"Error #sk2jrqF"))}),i.on("response",function(){t(i)}),s.getWsReady().then(function(t){t.sendObject(["SD|update",{ID:i.getID(),data:i.getResData(),error:i.getError()}])?i.setStatus(xSocket.Data.STATUS_RESPONSE):i.destroy("Error #e318Js")}).catch(function(t){i.destroy(t.message||"Error #er8avhT")})});return t.catch(function(){}),t},s.emit("data",i),s.emit("data|"+i.getType(),i),i.getTTL()||i.setStatus(xSocket.Data.STATUS_RESPONSE)):"SD|update"===t&&(i=s.getSocketData(e.ID))&&(i.setResData(e),i.setError(e.error),i.setStatus(xSocket.Data.STATUS_RESPONSE)))})},xSocket.Client=function(e,f,n){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var h,S=this,g=[],d=new xSocket.xSocketObject;this.getSettings=function(){return n||{}},this.getSettingsVal=function(t,e){return this.getSettings()[t]||e},this.getSocketObject=function(){return d},this.getConnection=function(){return new Promise(function(e,t){if("object"==typeof h)return e(h);if(null===h)return S.once("ws|connect",function(t){e(t)});h=null;var n=1<g.length?xSocket.helpers.getRandInt(0,g.length-1):g[0];if(n+=-1===n.indexOf("?")?"?":"&",d.getID().length&&d.getSign().length&&(f.xSOId=String(d.getID()),f.xSOSign=String(d.getSign())),Object.keys(f).length)for(var o in f)n+=String(o)+"="+String(f[o])+"&";var i,r=new xSocket.WebSocket(n);r.closeConnection=function(t){if(r.isConnection())try{return r.close(1e3,String(t||"close")),!0}catch(t){console.error(t)}return!1},r.isConnection=function(){return 1===r.readyState},r.sendMessage=function(t){try{if(this.isConnection())return r.send(String(t)),!0}catch(t){}return!1},r.sendObject=function(t){try{if(r.isConnection())return r.send(JSON.stringify(t)),!0}catch(t){}return!1},r.query={};var s=!(r.onopen=function(){h=r,S.emit("ws|connect",r)});r.onerror=function(t){i=t.message,S.emit("ws|error",t.message,r)};var c=0,u=setInterval(function(){r.sendMessage("ping")},1e4),a=setInterval(function(){c||r.closeConnection("pongTimeout"),c=0},23e3);r.onmessage=function(t){c++;var e=String(t.data||"");if("pong"!==e)try{var n=JSON.parse(e);if("object"==typeof n&&"string"==typeof n[0]&&"object"==typeof n[1]){if("SO|update"===n[0])return r.query=n[1],void(d.update(r)?s=!0:r.closeConnection("update"));s&&d.emit("ws|message",n[0],n[1])}}catch(t){}},r.onclose=function(t){try{clearInterval(u)}catch(t){}try{clearInterval(a)}catch(t){}h=void 0,i=i||t.reason||"close",d.emit("ws|disconnect",i),S.emit("ws|disconnect",i)}})},this.send=function(){return d.send.apply(this,arguments)},this.sendReadyResponse=function(){return d.sendReadyResponse.apply(this,arguments)},this.sendReady=function(){return d.sendReady.apply(this,arguments)},this.disconnect=function(t){return this.getSocketObject().disconnect(t)},function(){if("object"==typeof e)for(var t in e)g.push(e[t]);else"string"==typeof e&&g.push(e);if(!g.length)throw new Error("Invalid urlList");n="object"==typeof n?n:{},f="object"==typeof f?f:{},S.on("ws|disconnect",function(){setTimeout(function(){S.getConnection().catch(function(){})},1e3)}),d.on("connect",function(t){S.emit("connect",t)}),d.on("disconnect",function(t,e){S.emit("disconnect",t,e)}),d.on("reconnect",function(t){S.emit("reconnect",t)}),d.on("update",function(t){S.emit("update",t)}),d.on("ws|error",function(t,e){S.emit("error",t,e)}),d.on("data",function(t){S.emit("data",t)}),S.getConnection().catch(function(t){console.error(t)}),xSocket.helpers.getWindow()?xSocket.helpers.getWindow().addEventListener("unload",function(){try{h.closeConnection("end")}catch(t){}}):xSocket.helpers.getProcess()&&xSocket.helpers.getProcess().on("exit",function(){try{h.closeConnection("end")}catch(t){}})}()};