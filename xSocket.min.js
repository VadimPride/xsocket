var xSocket=function t(){t.Client.apply(this,arguments)};xSocket.window=window||!1,xSocket.WebSocket=WebSocket||!1,xSocket.process=!1,(window.xSocket=xSocket).helpers=new function(){this.getWindow=function(){return xSocket.window},this.getProcess=function(){return xSocket.process},this.getRandInt=function(t,e){return Math.floor(t+Math.random()*(e+1-t))},this.EventEmitter=function(){var c=this,u={},o=0,i=10,a="_once";this.on=function(t,e,n){if("string"!=typeof t||"function"!=typeof e)return c;++o;n=String(String(o)+(!0===n?a:""));return"object"!=typeof u[t]&&(u[t]={}),u[t][n]=e,0<i&&c.listenerCount(t)>i&&console.warn("EventEmitter ",t,", exceeded maxListeners : ",i+"/"+c.listenerCount(t),". Use EE.setMaxListeners(n)!"),c},this.once=function(t,e){return c.on(t,e,!0)},this.getListerensName=function(){return Object.keys(u)},this.clearAllListerens=function(){var t,e=c.getListerensName();for(t in e)c.offAll(e[t]);return u},this.listenerCount=function(t){return"string"!=typeof t||"object"!=typeof u[t]?0:Object.keys(u[t]).length},this.setMaxListeners=function(t){return"number"==typeof t&&(i=parseInt(t),!0)},this.off=function(t,e){if("string"!=typeof t||"function"!=typeof e||"object"!=typeof u[t])return c;for(var n in u[t])u[t][n]===e&&delete u[t][n];return 0===Object.keys(u[t]).length&&delete u[t],c},this.offAll=function(t){if("object"!=typeof u[t])return c;for(var e in u[t])delete u[t][e];return delete u[t],c},this.emit=function(t,e,n,o,i,r){if("string"!=typeof t||"object"!=typeof u[t])return c;for(var s in u[t])if("function"==typeof u[t][s]){u[t][s].call(this,e,n,o,i,r);try{0<=s.indexOf(a)&&c.off(t,u[t][s])}catch(t){}}return c}},this.getUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t,e){return("x"==t?e=16*Math.random()|0:3&e|8).toString(16)})},this.checkUID=function(t){return!!new RegExp("^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$").test(String(t))}},xSocket.Data=function(t,e,n){e="object"==typeof e?e:{},xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var o,i,r=this;this.__ID="string"==typeof e.ID?e.ID:"",this.__type="string"==typeof e.type?e.type:"",this.__data="object"==typeof e.data?e.data:{},this.__ttl="number"==typeof e.ttl&&e.ttl%1==0&&0<=e.ttl?e.ttl:3e3,this.__resData={},this.__error=!1,this.__status=xSocket.Data.STATUS_NEW,this.__destroy=!1,this.getID=function(){return String(this.__ID)},this.getType=function(){return String(this.__type)},this.getTTL=function(){return this.__ttl},this.getData=function(){return this.__data||{}},this.getDataVal=function(t,e){return this.getData()[t]||e},this.getResData=function(){return this.__resData||{}},this.getResDataVal=function(t,e){return this.getResData()[t]||e},this.getStatus=function(){return parseInt(this.__status)},this.getDestroy=function(){return this.__destroy||!1},this.getSocketObject=function(){return n||!1},this.response=function(t){return new Promise(function(){throw new Error("This SocketData is output, use response event")})},this.getError=function(){return this.__error||!1},this.isNew=function(){return this.__status===xSocket.Data.STATUS_NEW},this.isSend=function(){return this.__status===xSocket.Data.STATUS_SEND},this.isResponse=function(){return this.__status===xSocket.Data.STATUS_RESPONSE},this.send=function(){return new Promise(function(e,n){if(r.getDestroy())return n(new Promise(r.getDestroy));t&&r.emit("send"),r.on("response",function(t){e(t)}),r.on("destroy",function(t){n(new Error(t))})})},this.setStatus=function(t){return-1!==[xSocket.Data.STATUS_SEND,xSocket.Data.STATUS_RESPONSE].indexOf(t)&&this.getStatus()!==xSocket.Data.STATUS_RESPONSE&&this.getStatus()!==t&&(this.__status=t,this.emit("setStatus",t),!0)},this.setError=function(t){return"string"==typeof t&&(this.__error=String(t),!0)},this.setResData=function(t){return"object"==typeof t&&(this.__resData=t,!0)},this.destroy=function(t,e){if(this.getDestroy())return!1;this.__destroy=String("string"==typeof t&&t.length?t:"destroy"),e&&!this.getError()&&this.setError(this.__destroy),this.getStatus()!==xSocket.Data.STATUS_RESPONSE&&r.setStatus(xSocket.Data.STATUS_RESPONSE),this.emit("destroy",this.__destroy),this.clearAllListerens()},o=setTimeout(function(){r.destroy("ttl",!0)},r.getTTL()),i=setTimeout(function(t){t.destroy("responseTimeout",!0)},1e4<r.getTTL()?r.getTTL():1e4,r),r.once("destroy",function(){try{clearTimeout(i)}catch(t){}try{clearTimeout(o)}catch(t){}}),r.on("setStatus",function(t){t===xSocket.Data.STATUS_RESPONSE&&(r.emit("response",r.getResData(),r.getError()),r.destroy("response"))})},xSocket.Data.STATUS_NEW=0,xSocket.Data.STATUS_SEND=1,xSocket.Data.STATUS_RESPONSE=2,xSocket.xSocketObject=function(e,t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var s=this,n=void 0,o="",i="",r=void 0,c=!0,u={},a={};this.getID=function(){return o||""},this.getSign=function(){return i||""},this.getReq=function(){return t||{}},this.getQuery=function(){return"object"==typeof a?a:{}},this.getQueryVal=function(t,e){return this.getQuery()[t]||e},this.getReqHeaders=function(){return this.getReq().headers||{}},this.getOrigin=function(){return this.getReqHeaders().origin||"unknown"},this.getIP=function(){return String((this.getReq().connection||{}).remoteAddress||"unknown")},this.getSocketDataList=function(){return u},this.getSocketData=function(t){return this.getSocketDataList()[t]||!1},this.isConnection=function(){return"object"==typeof n&&n.isConnection()},this.getConnection=function(){return!!this.isConnection()&&n},this.getDestroy=function(){return r||!1},this.isDestroy=function(){return!!this.getDestroy()},this.getWsReady=function(){return new Promise(function(t,e){if(s.getConnection())return t(s.getConnection());function n(){e(new Error("destroy"))}s.on("connect",function(){s.getConnection()?t(s.getConnection()):e(new Error("Failed connection #10fg42w")),s.off("destroy",n)}),s.once("destroy",n)})},this.send=function(o,i,r){var t=new Promise(function(t,e){var n=new xSocket.Data(!0,{ID:xSocket.helpers.getUID(),type:o,data:i,ttl:r},s);n.getTTL()&&(u[n.getID()]=n).on("destroy",function(){delete u[n.getID()]}),t(n),s.getWsReady().then(function(t){return t.sendObject(["SD|create",{ID:n.getID(),type:n.getType(),ttl:n.getTTL(),data:n.getData()}])?void n.setStatus(n.getTTL()?xSocket.Data.STATUS_SEND:xSocket.Data.STATUS_RESPONSE):n.destroy("Failed send #54te8ta65")}).catch(function(t){n.destroy(t.message||"Failed send #2e4uxDql")})});return t.catch(function(){}),t},this.sendReadyResponse=function(t,e,n){return new Promise(function(o,i){s.send(t,e,n).then(function(n){return n.isResponse()||n.getDestroy()?n.getError()?i(new Error(n.getError())):o(n):void n.on("response",function(t,e){return e?i(new Error(e)):void o(n)})}).catch(function(t){i(t)})})},this.sendReady=this.sendReadyResponse,this.destroy=function(t){return!s.isDestroy()&&(r=String(t||"destroy"),this.disconnect(r),this.emit("destroy",this,r),this.clearAllListerens(),!0)},this.disconnect=function(t){var e=this.getConnection();return!(!e||!this.isConnection())&&e.closeConnection(t)},this.update=function(t){return"object"==typeof t&&"function"==typeof t.isConnection&&"object"==typeof t.query&&(!(!t.isConnection()||r)&&(o===t.query.xSOId&&i===t.query.xSOSign||(o=t.query.xSOId,i=t.query.xSOSign,(a=Object(t.query||{})).xSOId&&delete a.xSOId,a.xSOSign&&delete a.xSOSign,s.emit("update",s)),s.isServer()&&t.sendObject(["SO|update",{xSOId:s.getID(),xSOSign:s.getSign(),configure:"object"==typeof e?e:{}}]),(n=t).SocketObject=t,s.emit("ws|connect",t),!0))},this.isServer=function(){return!!e},s.on("destroy",function(){var t,e=s.getSocketDataList();for(t in e)try{e[t].destroy("SocketObject|destroy")}catch(t){}}),s.on("update",function(){s.isServer()}),s.on("ws|disconnect",function(t){s.emit("disconnect",s,t="string"==typeof t?t:"unknown"),"end"===t&&s.destroy("end")}),s.on("ws|connect",function(){s.emit("connect",s),c?c=!1:s.emit("reconnect",s)}),s.on("ws|message",function(t,e){var i;"string"==typeof t&&t.length&&"object"==typeof e&&"string"==typeof e.ID&&xSocket.helpers.checkUID(e.ID)&&e.ID.length&&"object"==typeof e.data&&("SD|create"===t?("string"==typeof e.type&&e.type.length||!s.getSocketData(e.ID))&&((i=new xSocket.Data(!1,e,s)).response=function(n,o){var t=new Promise(function(t,e){if(i.getDestroy()||i.isResponse()||!i.getTTL())return e("destroy");i.setResData(n),i.setError(o),i.on("destroy",function(t){e(new Error(t||"Error #sk2jrqF"))}),i.on("response",function(){t(i)}),s.getWsReady().then(function(t){t.sendObject(["SD|update",{ID:i.getID(),data:i.getResData(),error:i.getError()}])?i.setStatus(xSocket.Data.STATUS_RESPONSE):i.destroy("Error #e318Js")}).catch(function(t){i.destroy(t.message||"Error #er8avhT")})});return t.catch(function(){}),t},s.emit("data",i),s.emit("data|"+i.getType(),i),i.getTTL()||i.setStatus(xSocket.Data.STATUS_RESPONSE)):"SD|update"===t&&(i=s.getSocketData(e.ID))&&(i.setResData(e.data),i.setError(e.error||!1),i.setStatus(xSocket.Data.STATUS_RESPONSE)))})},xSocket.Client=function(e,c,n){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var u,a=this,f=[],h=!1;this.getSettings=function(){return n||{}},this.getSettingsVal=function(t,e){return this.getSettings()[t]||e},this.getSocketObject=function(){return h},this.getSocketObjectReady=function(){return new Promise(function(e){if(a.getSocketObject())return e(a.getSocketObject());a.on("connect",function(t){e(t)})})},this.getWs=function(){return new Promise(function(e){if("object"==typeof u)return e(u);if(null===u)return a.once("ws|connect",function(t){e(t)});u=null;var t=1<f.length?xSocket.helpers.getRandInt(0,f.length-1):f[0];if(t+=-1===t.indexOf("?")?"?":"&",h&&h.getID().length&&h.getSign().length&&(c.xSOId=String(h.getID()),c.xSOSign=String(h.getSign())),Object.keys(c).length)for(var n in c)try{t+=encodeURIComponent(String(n))+"="+encodeURIComponent(String(c[n]))+"&"}catch(t){}var o,r=new xSocket.WebSocket(t);r.closeConnection=function(t){if(r.isConnection())try{return r.close(1e3,String(t||"close")),!0}catch(t){console.error(t)}return!1},r.isConnection=function(){return 1===r.readyState},r.sendMessage=function(t){try{if(this.isConnection())return r.send(String(t)),!0}catch(t){}return!1},r.sendObject=function(t){try{if(r.isConnection())return r.send(JSON.stringify(t)),!0}catch(t){}return!1};var s=0,i=!1;r.onopen=function(){u=r,a.emit("ws|connect",r),i=setInterval(function(){s||r.closeConnection("pingTimeout"),s=0},21e3),e(u)},r.onmessage=function(t){s++;var e,n=String(t.data||"");if("ping"===n)return r.sendMessage("pong");try{if("object"!=typeof(e=JSON.parse(n))||"string"!=typeof e[0]||"object"!=typeof e[1])return;var o=e[0],i=e[1];if("SO|update"===o){if(r.query=i,h){if(i.xSOId===h.getID()&&i.xSOSign===h.getSign()&&h.update(r))return!1;h.destroy("update"),h=void 0}(h=new xSocket.xSocketObject).once("connect",function(){a.emit("connect",h)}),h.on("destroy",function(t,e){h=!1,a.emit("destroy",t,e)}),h.on("disconnect",function(){a.emit("disconnect",h)}),h.on("reconnect",function(){a.emit("reconnect",h)}),h.on("data",function(t){a.emit("data",t)}),h.update(r)||r.closeConnection("update")}else h&&h.emit("ws|message",e[0],e[1])}catch(t){}},r.onclose=function(t){if(i)try{clearInterval(i)}catch(t){}u=void 0,o=o||t.reason||"close",a.emit("ws|disconnect",o),h&&h.emit("ws|disconnect",o)},r.onerror=function(t){o=t.message,a.emit("ws|error",t.message,r)}})},this.send=function(){var t=arguments;return new Promise(function(e,n){a.getSocketObjectReady().then(function(){h.send.apply(this,t).then(function(t){e(t)}).catch(function(t){n(t)})}).catch(function(t){n(t)})})},this.sendReadyResponse=function(o,i,r){return new Promise(function(e,n){a.getSocketObjectReady().then(function(t){t.sendReadyResponse(o,i,r).then(function(t){e(t)}).catch(function(t){n(t)})}).catch(function(t){n(t)})})},this.sendReady=function(o,i,r){return new Promise(function(e,n){a.getSocketObjectReady().then(function(t){t.sendReady(o,i,r).then(function(t){e(t)}).catch(function(t){n(t)})}).catch(function(t){n(t)})})},this.disconnect=function(t){var e=this.getSocketObject();return!!e&&e.disconnect(t)},function(){if("object"==typeof e)for(var t in e)f.push(e[t]);else"string"==typeof e&&f.push(e);if(!f.length)throw new Error("Invalid urlList");n="object"==typeof n?n:{},c="object"==typeof c?c:{},a.on("ws|disconnect",function(){setTimeout(function(){a.getWs().catch(function(){})},1e3)}),a.on("ws|error",function(){setTimeout(function(){a.getWs().catch(function(){})},1e3)}),xSocket.helpers.getWindow()?xSocket.helpers.getWindow().addEventListener("unload",function(){try{u.closeConnection("end")}catch(t){}}):xSocket.helpers.getProcess()&&xSocket.helpers.getProcess().on("exit",function(){try{u.closeConnection("end")}catch(t){}}),a.on("connect",function(n){function e(t,e){if(o)try{clearTimeout(o),o=!1}catch(t){}t&&(e="number"==typeof e&&e!=e&&0<e?e:0,o=setTimeout(function(t){t.destroy(e),o=!1},e,n))}var o=!1;n.on("reconnect",function(){e(!1)}),n.on("disconnect",function(){var t=parseInt(Object(n.getQueryVal("configure",{})).socketObjectTimeout||0);"number"==typeof t&&e(!0,t)}),n.once("destroy",function(){e(!1)})}),a.getWs().catch(function(){})}()};