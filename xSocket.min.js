window.xSocket=function t(){t.Client.apply(this,arguments)},window.xSocket.WebSocket=WebSocket,xSocket.helpers=new function(){this.getRandInt=function(t,e){return Math.floor(t+Math.random()*(e+1-t))},this.EventEmitter=function(){var s=this,u={},o=0,i=10,a="_once";this.on=function(t,e,n){if("string"!=typeof t||"function"!=typeof e)return s;++o;n=String(String(o)+(!0===n?a:""));return"object"!=typeof u[t]&&(u[t]={}),u[t][n]=e,0<i&&s.listenerCount(t)>i&&console.warn("EventEmitter ",t,", exceeded maxListeners : ",i+"/"+s.listenerCount(t),". Use EE.setMaxListeners(n)!"),s},this.once=function(t,e){return s.on(t,e,!0)},this.getListerensName=function(){return Object.keys(u)},this.clearAllListerens=function(){var t,e=s.getListerensName();for(t in e)s.offAll(e[t]);return u},this.listenerCount=function(t){return"string"!=typeof t||"object"!=typeof u[t]?0:Object.keys(u[t]).length},this.setMaxListeners=function(t){return"number"==typeof t&&(i=parseInt(t),!0)},this.off=function(t,e){if("string"!=typeof t||"function"!=typeof e||"object"!=typeof u[t])return s;for(var n in u[t])u[t][n]===e&&delete u[t][n];return 0===Object.keys(u[t]).length&&delete u[t],s},this.offAll=function(t){if("object"!=typeof u[t])return s;for(var e in u[t])delete u[t][e];return delete u[t],s},this.emit=function(t,e,n,o,i,r){if("string"!=typeof t||"object"!=typeof u[t])return s;for(var c in u[t])"function"==typeof u[t][c]&&(u[t][c].call(this,e,n,o,i,r),0<=c.indexOf(a)&&s.off(t,u[t][c]));return s}},this.getUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t,e){return("x"==t?e=16*Math.random()|0:3&e|8).toString(16)})}},xSocket.Data=function(t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var e,n=this;this.__ID="",this.__type="",this.__data={},this.__resData={},this.__status=0,this.__destroy=!1,this.getID=function(){return String(this.__ID)},this.getType=function(){return String(this.__type)},this.getData=function(){return this.__data||{}},this.getResData=function(){return this.__resData},this.getStatus=function(){return parseInt(this.__status)},this.getDestroy=function(){return this.__destroy||!1},this.response=function(t){return new Promise(function(){throw new Error("This SocketData is output, use response event")})},this.destroy=function(t){if(this.getDestroy())return!1;this.__destroy=String("string"==typeof t&&t.length?t:"destroy"),this.__status!==xSocket.Data.STATUS_RESPONCE&&n.emit("response",{},this.__destroy),this.emit("destroy",n),this.clearAllListerens()},e=setTimeout(function(t){t.destroy("responseTimeout")},1e4,n),n.once("destroy",function(){try{clearTimeout(e)}catch(t){}}),n.once("response",function(t){n.__status=xSocket.Data.STATUS_RESPONCE,n.__resData=t,n.destroy("response")})},xSocket.Data.STATUS_NEW=0,xSocket.Data.STATUS_SEND=1,xSocket.Data.STATUS_RESPONCE=2,xSocket.xSocketObject=function(e,t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var s=this,n=void 0,o="",i="",r=void 0,c=!0,u={},a={};this.getID=function(){return o||""},this.getSign=function(){return i||""},this.getReq=function(){return t||{}},this.getQuery=function(){return"object"==typeof a?a:{}},this.getQueryVal=function(t,e){return this.getQuery()[t]||e},this.getReqHeaders=function(){return this.getReq().headers||{}},this.getOrigin=function(){return this.getReqHeaders().origin||"unknown"},this.getIP=function(){return String((this.getReq().connection||{}).remoteAddress||"unknown")},this.getSocketDataList=function(){return u},this.getSocketData=function(t){return this.getSocketDataList()[t]||!1},this.isConnection=function(){return"object"==typeof n&&n.isConnection()},this.getConnection=function(){return!!this.isConnection()&&n},this.getDestroy=function(){return r||!1},this.getWsReady=function(){return new Promise(function(t,e){if(s.getConnection())return t(s.getConnection());function n(){e(new Error("destroy"))}s.on("connect",function(){s.getConnection()?t(s.getConnection()):e(new Error("Failed connection #10fg42w")),s.off("destroy",n)}),s.once("destroy",n)})},this.send=function(t,r,c){var e=new Promise(function(e,n){if("string"!=typeof t||!t.length)throw new Error("Invalid type value");if("object"!=typeof r)throw new Error("Invalid data value");if("number"!=typeof(c=parseInt(c||0))||c!=c||c<0)throw new Error("Invalid ttl value");var o=new xSocket.Data(!0);o.__ID=xSocket.helpers.getUID(),o.__type=t,o.__data=r;var i=setTimeout(function(){o.destroy("ttl")},c);(u[o.getID()]=o).on("destroy",function(t){delete u[t.getID()]}),s.getWsReady().then(function(t){if(c&&"ttl"===o.getDestroy())return n(new Error("ttl"));if(t.sendObject(["SD|create",{ID:o.getID(),type:o.getType(),data:o.getData()}])){e(o);try{clearTimeout(i)}catch(t){}}else{t="Failed send #54te8ta65";n(new Error(t)),o.destroy(t)}}).catch(function(t){n(t)})});return e.catch(function(){}),e},this.destroy=function(t){return!r&&(r=String(t||"destroy"),this.disconnect(r),this.emit("destroy",this,r),this.clearAllListerens(),!0)},this.disconnect=function(t){var e=this.getConnection();return!(!e||!this.isConnection())&&e.closeConnection(t)},this.update=function(t){return"object"==typeof t&&"function"==typeof t.isConnection&&"object"==typeof t.query&&(!(!t.isConnection()||r)&&(o===t.query.xSOId&&i===t.query.xSOSign||(o=t.query.xSOId,i=t.query.xSOSign,(a=Object(t.query||{})).xSOId&&delete a.xSOId,a.xSOSign&&delete a.xSOSign,e||s.emit("update",s)),(n=t).SocketObject=t,s.emit("ws|connect",t),!0))},s.on("update",function(){var t,e=s.getSocketDataList();for(t in e)try{e[t].destroy("SocketObject|destroy")}catch(t){}}),s.on("ws|disconnect",function(t){s.emit("disconnect",s,String(t||""))}),s.on("ws|connect",function(){s.emit("connect",s),c?c=!1:s.emit("reconnect",s)}),s.on("ws|message",function(t,e){var i;"string"==typeof t&&t.length&&"object"==typeof e&&"string"==typeof e.ID&&e.ID.length&&"object"==typeof e.data&&("SD|create"===t?("string"==typeof e.type&&e.type.length||!s.getSocketData(e.ID))&&((i=new xSocket.Data).__ID=String(e.ID),i.__type=String(e.type),i.__data=Object(e.data),i.response=function(o){var t=new Promise(function(e,n){if("object"!=typeof o)return n(new Error("Invalid data object"));s.getWsReady().then(function(t){t.sendObject(["SD|update",{ID:i.getID(),data:o}])?(e(i),i.destroy()):n(new Error("Failed send"))}).catch(function(t){n(t)})});return t.catch(function(){}),t},s.emit("data",i),s.emit("|"+i.getType(),i)):"SD|update"===t&&(i=s.getSocketData(e.ID))&&i.emit("response",e.data,!1))})},xSocket.Client=function(s,u,t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var a,f=this,h=new xSocket.xSocketObject;this.getSettings=function(){return t||{}},this.getSettingsVal=function(t,e){return this.getSettings()[t]||e},this.getSocketObject=function(){return h},this.getConnection=function(){return new Promise(function(e,t){if("object"==typeof a)return e(a);if(null===a)return f.once("ws|connect",function(t){e(t)});a=null;var n=1<s.length?xSocket.helpers.getRandInt(0,s.length-1):s[0];if(console.log(n),n+=-1===n.indexOf("?")?"?":"&",h.getID().length&&h.getSign().length&&(u.xSOId=String(h.getID()),u.xSOSign=String(h.getSign())),Object.keys(u).length)for(var o in u)n+=String(o)+"="+String(u[o])+"&";var i,r=new xSocket.WebSocket(n);r.closeConnection=function(t){if(r.isConnection())try{return r.close(1e3,String(t||"close")),!0}catch(t){console.error(t)}return!1},r.isConnection=function(){return 1===r.readyState},r.sendMessage=function(t){try{if(this.isConnection())return r.send(String(t)),!0}catch(t){}return!1},r.sendObject=function(t){try{if(r.isConnection())return r.send(JSON.stringify(t)),!0}catch(t){}return!1},r.query={};var c=!(r.onopen=function(){a=r,f.emit("ws|connect",r)});r.onerror=function(t){i=t.message,f.emit("ws|error",t.message,r)},r.onmessage=function(t){var e=String(t.data||"");if("pong"!==e)try{var n=JSON.parse(e);if("object"==typeof n&&"string"==typeof n[0]&&"object"==typeof n[1]){if("SO|update"===n[0])return r.query=n[1],void(h.update(r)?c=!0:r.closeConnection("update"));c&&h.emit("ws|message",n[0],n[1])}}catch(t){}},r.onclose=function(t){a=void 0,i=i||t.reason||"close",c&&h.emit("ws|disconnect",i),f.emit("ws|disconnect",i)}})},this.disconnect=function(t){return this.getSocketObject().disconnect(t)},function(){if(!(s="object"==typeof s?s:[]).length)throw new Error("Invalid urlList");t="object"==typeof t?t:{},u="object"==typeof u?u:{},f.on("ws|disconnect",function(){setTimeout(function(){f.getConnection().catch(function(){})},1e3)}),h.on("connect",function(t){f.emit("connect",t)}),h.on("disconnect",function(t,e){f.emit("disconnect",t,e)}),h.on("reconnect",function(t){f.emit("reconnect",t)}),h.on("update",function(t){f.emit("update",t)}),f.getConnection().catch(function(t){console.error(t)})}()};