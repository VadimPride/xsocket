window.xSocket=function t(){t.Client.apply(this,arguments)},window.xSocket.window=window,window.xSocket.WebSocket=WebSocket,xSocket.helpers=new function(){this.getRandInt=function(t,e){return Math.floor(t+Math.random()*(e+1-t))},this.EventEmitter=function(){var c=this,u={},o=0,i=10,a="_once";this.on=function(t,e,n){if("string"!=typeof t||"function"!=typeof e)return c;++o;n=String(String(o)+(!0===n?a:""));return"object"!=typeof u[t]&&(u[t]={}),u[t][n]=e,0<i&&c.listenerCount(t)>i&&console.warn("EventEmitter ",t,", exceeded maxListeners : ",i+"/"+c.listenerCount(t),". Use EE.setMaxListeners(n)!"),c},this.once=function(t,e){return c.on(t,e,!0)},this.getListerensName=function(){return Object.keys(u)},this.clearAllListerens=function(){var t,e=c.getListerensName();for(t in e)c.offAll(e[t]);return u},this.listenerCount=function(t){return"string"!=typeof t||"object"!=typeof u[t]?0:Object.keys(u[t]).length},this.setMaxListeners=function(t){return"number"==typeof t&&(i=parseInt(t),!0)},this.off=function(t,e){if("string"!=typeof t||"function"!=typeof e||"object"!=typeof u[t])return c;for(var n in u[t])u[t][n]===e&&delete u[t][n];return 0===Object.keys(u[t]).length&&delete u[t],c},this.offAll=function(t){if("object"!=typeof u[t])return c;for(var e in u[t])delete u[t][e];return delete u[t],c},this.emit=function(t,e,n,o,i,r){if("string"!=typeof t||"object"!=typeof u[t])return c;for(var s in u[t])"function"==typeof u[t][s]&&(u[t][s].call(this,e,n,o,i,r),0<=s.indexOf(a)&&c.off(t,u[t][s]));return c}},this.getUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t,e){return("x"==t?e=16*Math.random()|0:3&e|8).toString(16)})},this.checkUID=function(t){return!!new RegExp("^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$").test(String(t))}},xSocket.Data=function(t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var e,n=this;this.__ID="",this.__type="",this.__data={},this.__resData={},this.__status=0,this.__destroy=!1,this.getID=function(){return String(this.__ID)},this.getType=function(){return String(this.__type)},this.getData=function(){return this.__data||{}},this.getResData=function(){return this.__resData},this.getStatus=function(){return parseInt(this.__status)},this.getDestroy=function(){return this.__destroy||!1},this.response=function(t){return new Promise(function(){throw new Error("This SocketData is output, use response event")})},this.destroy=function(t){if(this.getDestroy())return!1;this.__destroy=String("string"==typeof t&&t.length?t:"destroy"),this.__status!==xSocket.Data.STATUS_RESPONCE&&n.emit("response",{},this.__destroy),this.emit("destroy",n),this.clearAllListerens()},e=setTimeout(function(t){t.destroy("responseTimeout")},1e4,n),n.once("destroy",function(){try{clearTimeout(e)}catch(t){}}),n.once("response",function(t){n.__status=xSocket.Data.STATUS_RESPONCE,n.__resData=t,n.destroy("response")})},xSocket.Data.STATUS_NEW=0,xSocket.Data.STATUS_SEND=1,xSocket.Data.STATUS_RESPONCE=2,xSocket.xSocketObject=function(e,t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var c=this,n=void 0,o="",i="",r=void 0,s=!0,u={},a={};this.getID=function(){return o||""},this.getSign=function(){return i||""},this.getReq=function(){return t||{}},this.getQuery=function(){return"object"==typeof a?a:{}},this.getQueryVal=function(t,e){return this.getQuery()[t]||e},this.getReqHeaders=function(){return this.getReq().headers||{}},this.getOrigin=function(){return this.getReqHeaders().origin||"unknown"},this.getIP=function(){return String((this.getReq().connection||{}).remoteAddress||"unknown")},this.getSocketDataList=function(){return u},this.getSocketData=function(t){return this.getSocketDataList()[t]||!1},this.isConnection=function(){return"object"==typeof n&&n.isConnection()},this.getConnection=function(){return!!this.isConnection()&&n},this.getDestroy=function(){return r||!1},this.isDestroy=function(){return!!this.getDestroy()},this.getWsReady=function(){return new Promise(function(t,e){if(c.getConnection())return t(c.getConnection());const n=function(){e(new Error("destroy"))};c.on("connect",function(){c.getConnection()?t(c.getConnection()):e(new Error("Failed connection #10fg42w")),c.off("destroy",n)}),c.once("destroy",n)})},this.send=function(t,r,s){var e=new Promise(function(e,n){if("string"!=typeof t||!t.length)throw new Error("Invalid type value");if("object"!=typeof r)throw new Error("Invalid data value");if("number"!=typeof(s=parseInt(s||4e3))||s!=s||s<0)throw new Error("Invalid ttl value");var o=new xSocket.Data(!0);o.__ID=xSocket.helpers.getUID(),o.__type=t,o.__data=r,(u[o.getID()]=o).on("destroy",function(t){return delete u[t.getID()],n(new Error("ttl"))});var i=setTimeout(function(){o.destroy("ttl")},s);c.getWsReady().then(function(t){if(s&&"ttl"===o.getDestroy())return n(new Error("ttl"));if(t.sendObject(["SD|create",{ID:o.getID(),type:o.getType(),data:o.getData()}])){e(o);try{clearTimeout(i)}catch(t){}}else{t="Failed send #54te8ta65";n(new Error(t)),o.destroy(t)}}).catch(function(t){n(t)})});return e.catch(function(){}),e},this.sendReadyResponse=function(t,e,i){return new Promise(function(n,o){c.send(t,e,i).then(function(t){t.on("response",function(t,e){return e?o(new Error(e)):void n(t)})}).catch(function(t){o(t)})})},this.transportSocketData=function(o,t){return new Promise(function(e,n){c.sendReadyResponse(o.getType(),o.getData(),t).then(function(t){e(t),o.response(t)}).catch(function(t){n(t),o.destroy(t.message)})})},this.destroy=function(t){return!r&&(r=String(t||"destroy"),this.disconnect(r),this.emit("destroy",this,r),this.clearAllListerens(),!0)},this.disconnect=function(t){var e=this.getConnection();return!(!e||!this.isConnection())&&e.closeConnection(t)},this.update=function(t){return"object"==typeof t&&"function"==typeof t.isConnection&&"object"==typeof t.query&&(!(!t.isConnection()||r)&&(o===t.query.xSOId&&i===t.query.xSOSign||(o=t.query.xSOId,i=t.query.xSOSign,(a=Object(t.query||{})).xSOId&&delete a.xSOId,a.xSOSign&&delete a.xSOSign,e||c.emit("update",c)),(n=t).SocketObject=t,c.emit("ws|connect",t),!0))},c.on("update",function(){var t,e=c.getSocketDataList();for(t in e)try{e[t].destroy("SocketObject|destroy")}catch(t){}}),c.on("ws|disconnect",function(t){c.emit("disconnect",c,String(t||"")),"end"===t&&c.destroy("end")}),c.on("ws|connect",function(){c.emit("connect",c),s?s=!1:c.emit("reconnect",c)}),c.on("ws|message",function(t,e){var i;"string"==typeof t&&t.length&&"object"==typeof e&&"string"==typeof e.ID&&xSocket.helpers.checkUID(e.ID)&&e.ID.length&&"object"==typeof e.data&&("SD|create"===t?("string"==typeof e.type&&e.type.length||!c.getSocketData(e.ID))&&((i=new xSocket.Data).__ID=String(e.ID),i.__type=String(e.type),i.__data=Object(e.data),i.response=function(o){var t=new Promise(function(e,n){if("object"!=typeof o)return n(new Error("Invalid data object"));c.getWsReady().then(function(t){t.sendObject(["SD|update",{ID:i.getID(),data:o}])?(e(i),i.destroy()):n(new Error("Failed send"))}).catch(function(t){n(t)})});return t.catch(function(){}),t},c.emit("data",i),c.emit("|"+i.getType(),i)):"SD|update"===t&&(i=c.getSocketData(e.ID))&&i.emit("response",e.data,!1))})},xSocket.Client=function(f,h,t){xSocket.helpers.EventEmitter.call(this),this.setMaxListeners(0);var d,g=this,y=new xSocket.xSocketObject;this.getSettings=function(){return t||{}},this.getSettingsVal=function(t,e){return this.getSettings()[t]||e},this.getSocketObject=function(){return y},this.getConnection=function(){return new Promise(function(e,t){if("object"==typeof d)return e(d);if(null===d)return g.once("ws|connect",function(t){e(t)});d=null;var n=1<f.length?xSocket.helpers.getRandInt(0,f.length-1):f[0];if(n+=-1===n.indexOf("?")?"?":"&",y.getID().length&&y.getSign().length&&(h.xSOId=String(y.getID()),h.xSOSign=String(y.getSign())),Object.keys(h).length)for(var o in h)n+=String(o)+"="+String(h[o])+"&";var i,r=new xSocket.WebSocket(n);r.closeConnection=function(t){if(r.isConnection())try{return r.close(1e3,String(t||"close")),!0}catch(t){console.error(t)}return!1},r.isConnection=function(){return 1===r.readyState},r.sendMessage=function(t){try{if(this.isConnection())return r.send(String(t)),!0}catch(t){}return!1},r.sendObject=function(t){try{if(r.isConnection())return r.send(JSON.stringify(t)),!0}catch(t){}return!1},r.query={};var s=!(r.onopen=function(){d=r,g.emit("ws|connect",r)});r.onerror=function(t){i=t.message,g.emit("ws|error",t.message,r)};var c=0,u=setInterval(function(){r.sendMessage("ping")},1e4),a=setInterval(function(){c||r.closeConnection("pongTimeout"),c=0},23e3);r.onmessage=function(t){c++;var e=String(t.data||"");if("pong"!==e)try{var n=JSON.parse(e);if("object"==typeof n&&"string"==typeof n[0]&&"object"==typeof n[1]){if("SO|update"===n[0])return r.query=n[1],void(y.update(r)?s=!0:r.closeConnection("update"));s&&y.emit("ws|message",n[0],n[1])}}catch(t){}},r.onclose=function(t){try{clearInterval(u)}catch(t){}try{clearInterval(a)}catch(t){}d=void 0,i=i||t.reason||"close",y.emit("ws|disconnect",i),g.emit("ws|disconnect",i)}})},this.getWindow=function(){return xSocket.window||!1},this.send=function(){return y.send.apply(this,arguments)},this.sendReadyResponse=function(){return y.sendReadyResponse.apply(this,arguments)},this.disconnect=function(t){return this.getSocketObject().disconnect(t)},function(){if(!(f="object"==typeof f?f:[]).length)throw new Error("Invalid urlList");t="object"==typeof t?t:{},h="object"==typeof h?h:{},g.on("ws|disconnect",function(){setTimeout(function(){g.getConnection().catch(function(){})},1e3)}),y.on("connect",function(t){g.emit("connect",t)}),y.on("disconnect",function(t,e){g.emit("disconnect",t,e)}),y.on("reconnect",function(t){g.emit("reconnect",t)}),y.on("update",function(t){g.emit("update",t)}),y.on("ws|error",function(t,e){g.emit("error",t,e)}),y.on("data",function(t){g.emit("data",t)}),g.getConnection().catch(function(t){console.error(t)}),g.getWindow()&&g.getWindow().addEventListener("unload",function(){try{d.closeConnection("end")}catch(t){}})}()};